name: Build WordPress Plugin

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Dependencies
      run: npm ci

    - name: Build Project
      run: npm run build

    - name: Create Plugin Structure
      run: |
        mkdir -p wpspeedmaster-plugin/dist
        # Copy the dist folder contents (built by Vite)
        cp -r dist/* wpspeedmaster-plugin/dist/
        # Copy PHP files
        cp wpspeedmaster-widgets.php wpspeedmaster-plugin/
        cp elementor-widget.php wpspeedmaster-plugin/
        
        # Check if metadata exists, else create dummy
        if [ -f metadata.json ]; then
          cp metadata.json wpspeedmaster-plugin/
        fi

    - name: Zip Plugin
      run: |
        cd wpspeedmaster-plugin
        zip -r ../wpspeedmaster-plugin.zip ./*

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: wpspeedmaster-plugin
        path: wpspeedmaster-plugin.zip
